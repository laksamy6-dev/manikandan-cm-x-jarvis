# -*- coding: utf-8 -*-
# ==============================================================================
#   PROJECT: CM-X GENESIS ULTIMATE (GITHUB EDITION)
#   OWNER: Boss Manikandan Rajendran
#   ASSISTANT: Chellakili (AI Co-Pilot)
# ==============================================================================

import asyncio
import json
import time
import random
import os
import sys
from datetime import datetime
from dotenv import load_dotenv  # à®°à®•à®šà®¿à®¯ à®•à¯€à®¯à¯ˆ à®Žà®Ÿà¯à®•à¯à®• à®‰à®¤à®µà¯à®®à¯
from rich.console import Console
from rich.panel import Panel
from rich.text import Text

# --- 1. SETUP & CONFIGURATION ---
# .env à®ƒà®ªà¯ˆà®²à®¿à®²à¯ à®‡à®°à¯à®¨à¯à®¤à¯ à®°à®•à®šà®¿à®¯à®™à¯à®•à®³à¯ˆ à®à®±à¯à®±à¯à®¤à®²à¯
load_dotenv()

UPSTOX_TOKEN = os.getenv("UPSTOX_ACCESS_TOKEN")
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
MODE = os.getenv("TRADING_MODE", "PAPER")

console = Console()
MEMORY_FILE = "cm_x_core_memory.json"

# --- 2. THE ETERNAL MEMORY (à®…à®´à®¿à®¯à®¾à®¤ à®¨à®¿à®©à¯ˆà®µà®•à®®à¯) ---
class DigitalBrain:
    def __init__(self):
        self.knowledge_base = self.load_memory()
        
    def load_memory(self):
        if os.path.exists(MEMORY_FILE):
            try:
                with open(MEMORY_FILE, 'r') as f:
                    return json.load(f)
            except:
                return self._default_knowledge()
        else:
            return self._default_knowledge()

    def _default_knowledge(self):
        return {
            "strategies": {
                "PHYSICS_MOMENTUM": 1.5,
                "FII_DATA_TRACKER": 1.2,
                "PRICE_ACTION": 1.0
            },
            "lessons_learned": [],
            "total_xp": 0
        }

    def save_memory(self):
        with open(MEMORY_FILE, 'w') as f:
            json.dump(self.knowledge_base, f, indent=4)

    def learn_lesson(self, lesson_text):
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M")
        entry = f"[{timestamp}] {lesson_text}"
        self.knowledge_base["lessons_learned"].append(entry)
        self.knowledge_base["total_xp"] += 10
        self.save_memory()
        console.print(f"[bold green] ðŸ§  à®ªà®¾à®Ÿà®®à¯ à®•à®±à¯à®±à¯à®•à¯ à®•à¯Šà®³à¯à®³à®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯! (+10 XP)[/bold green]")

# --- 3. DATA INJECTOR (à®•à®£à¯à®•à®³à¯ à®®à®±à¯à®±à¯à®®à¯ à®•à®¾à®¤à¯à®•à®³à¯) ---
class DataInjestor:
    def __init__(self):
        console.print("[cyan] ðŸ“¡ Connecting to Global Data Stream...[/cyan]")
        if not UPSTOX_TOKEN:
            console.print("[bold red] âš ï¸ WARNING: Upstox Token à®•à®¾à®£à®µà®¿à®²à¯à®²à¯ˆ! Simulation Mode-à®²à¯ à®“à®Ÿà¯à®•à®¿à®±à®¤à¯.[/bold red]")
        
    def scan_market(self):
        # à®°à®¿à®¯à®²à¯ API à®•à®©à¯†à®•à¯à®·à®©à¯ à®‡à®²à¯à®²à®¾à®¤ à®ªà¯‹à®¤à¯ Simulation à®“à®Ÿà¯à®®à¯
        # à®Žà®¤à®¿à®°à¯à®•à®¾à®²à®¤à¯à®¤à®¿à®²à¯ à®‡à®™à¯à®•à¯‡ Upstox Logic-à® à®‡à®£à¯ˆà®•à¯à®•à®²à®¾à®®à¯
        market_mood = random.choice(["BULLISH", "BEARISH", "SIDEWAYS"])
        velocity = random.uniform(-10, 10) 
        fii_activity = random.choice(["BUYING", "SELLING", "NEUTRAL"])
        
        return {
            "mood": market_mood,
            "velocity": velocity,
            "fii": fii_activity,
            "price": 19500 + random.randint(-50, 50)
        }

# --- 4. THE MENTOR ENGINE (à®µà®¾à®¤à¯à®¤à®¿à®¯à®¾à®°à¯ à®®à¯‹à®Ÿà¯) ---
class MentorAssistant:
    def __init__(self, brain):
        self.brain = brain

    def explain_decision(self, decision, reason_data):
        console.print(Panel(f"""
[bold yellow]ðŸ—£ï¸ CM-X TEACHER MODE[/bold yellow]
-----------------------------------------
ðŸ”” [bold white]à®®à¯à®Ÿà®¿à®µà¯:[/bold white] {decision}
â“ [bold white]à®•à®¾à®°à®£à®®à¯:[/bold white]
   1. [cyan]Physics Velocity:[/cyan] {reason_data['velocity']:.2f} (à®µà¯‡à®•à®®à¯)
   2. [cyan]FII Activity:[/cyan] {reason_data['fii']} (à®ªà®£à®®à¯)

ðŸ’¡ [italic green]à®ªà®¾à®Ÿà®®à¯: à®µà¯‡à®•à®®à¯ à®…à®¤à®¿à®•à®®à®¾à®• à®‡à®°à¯à®•à¯à®•à¯à®®à¯à®ªà¯‹à®¤à¯ à®Ÿà®¿à®°à¯†à®£à¯à®Ÿà¯ à®ªà®•à¯à®•à®®à¯ à®ªà¯‹à®µà®¤à¯ à®ªà®¾à®¤à¯à®•à®¾à®ªà¯à®ªà¯![/italic green]
""", title="ASSISTANT LOG", border_style="blue"))

# --- 5. MAIN INTELLIGENCE LOOP ---
async def main():
    os.system('cls' if os.name == 'nt' else 'clear')
    console.print(Panel.fit("[bold magenta]ðŸ¤– CM-X GENESIS ULTIMATE (GITHUB EDITION)[/bold magenta]\n[white]Created by Boss Manikandan & Chellakili[/white]"))
    
    brain = DigitalBrain()
    data_feed = DataInjestor()
    mentor = MentorAssistant(brain)
    
    console.print(f"[bold yellow] ðŸ§  Current Brain XP: {brain.knowledge_base['total_xp']} Points[/bold yellow]\n")
    
    while True:
        live_data = data_feed.scan_market()
        
        # Physics Rule
        decision = "WAIT"
        if live_data['velocity'] > 4 and live_data['fii'] == "BUYING":
            decision = "BUY CE ðŸš€"
        elif live_data['velocity'] < -4 and live_data['fii'] == "SELLING":
            decision = "BUY PE ðŸ©¸"
            
        if decision != "WAIT":
            mentor.explain_decision(decision, live_data)
            time.sleep(2)
            console.print("[bold green] âœ… à®†à®°à¯à®Ÿà®°à¯ à®ªà¯‹à®Ÿà®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯... (Order Executed)[/bold green]")
            
            # Learning Phase
            brain.learn_lesson(f"à®µà¯†à®±à¯à®±à®¿ à®•à¯à®±à®¿à®ªà¯à®ªà¯: à®µà¯‡à®•à®®à¯ {live_data['velocity']:.1f} à®‡à®°à¯à®•à¯à®•à¯à®®à¯ à®ªà¯‹à®¤à¯ FII à®šà®ªà¯à®ªà¯‹à®°à¯à®Ÿà¯ à®‡à®°à¯à®¨à¯à®¤à®¾à®²à¯ à®²à®¾à®ªà®®à¯ à®‰à®±à¯à®¤à®¿.")
        else:
            print(f" â³ Market Watching... Velocity: {live_data['velocity']:.2f} | FII: {live_data['fii']}     ", end='\r')
        
        time.sleep(3)

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        console.print("\n[bold red] ðŸ›‘ SYSTEM SHUTDOWN INITIATED...[/bold red]")
